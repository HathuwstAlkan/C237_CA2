<!-- views/partials/navbar.ejs -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="/style.css">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="<%= user ? '/dashboard' : '/' %>">
            RP Bookstore<%= user && user.role === 'admin' ? ' Admin' : '' %>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link <%= typeof activePage !== 'undefined' && (activePage === 'books' || activePage === 'admin-books') ? 'active' : '' %>"
                       href="<%= user && user.role === 'admin' ? '/admin/books' : '/books' %>">
                        Books
                    </a>
                </li>
                <% if (user && user.role === 'admin') { %>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof activePage !== 'undefined' && activePage === 'customers' ? 'active' : '' %>" href="/admin/customers">Customers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= typeof activePage !== 'undefined' && activePage === 'stocks' ? 'active' : '' %>" href="/admin/stocks">Stocks</a>
                    </li>
                <% } %>
            </ul>

            <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                <% if (user) { %>
                    <% if (user.role === 'admin') { %>
                        <!-- Admin "View" dropdown -->
                        <li class="nav-item dropdown me-3">
                            <a class="nav-link dropdown-toggle" href="#" id="viewDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                View
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="viewDropdown">
                                <li><h6 class="dropdown-header">Switch View</h6></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="customerViewLink">Customer View</a></li>
                                <li><a class="dropdown-item" href="#" id="adminViewLink">Admin View</a></li>
                            </ul>
                        </li>
                    <% } %>
                    <!-- Profile Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle profile-image-link" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="<%= user.profile_image_url || '/assets/profile_headshot.png' %>"
                                 onerror="this.onerror=null;this.src='/assets/no_profile_headshot.png';"
                                 alt="Profile" class="profile-img">
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><h6 class="dropdown-header">Hi, <%= user.username %>!</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item <%= typeof activePage !== 'undefined' && activePage === 'profile' ? 'active' : '' %>" href="/profile">View Profile</a></li>
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                    <li class="nav-item ms-2">
                    <button id="theme-toggle-btn" class="btn btn-link p-0 theme-icon" title="Toggle dark mode" style="font-size:1.7rem;">
                        <i id="bulb-light" class="fa-regular fa-lightbulb"></i>
                        <i id="bulb-dark" class="fa-solid fa-lightbulb" style="display:none;"></i>
                    </button>
                    </li>
                <% } else { %>
                    <!-- Not logged in -->
                    <li class="nav-item">
                        <a class="btn btn-outline-light btn-sm me-2" href="/">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-light btn-sm" href="/">Sign Up</a>
                    </li>
                <% } %>
            </ul>
        </div>
    </div>
</nav>

<script>
(function() {
  const body = document.body;
  const btn = document.getElementById('theme-toggle-btn');
  const iconLight = document.getElementById('bulb-light');
  const iconDark = document.getElementById('bulb-dark');
  function applyTheme(dark) {
    if (dark) {
      body.classList.add('dark-mode');
      iconLight.style.display = 'none';
      iconDark.style.display = '';
    } else {
      body.classList.remove('dark-mode');
      iconLight.style.display = '';
      iconDark.style.display = 'none';
    }
  }
  let dark = localStorage.getItem('theme') === 'dark';
  applyTheme(dark);
  if (btn) btn.onclick = function() {
    dark = !body.classList.contains('dark-mode');
    applyTheme(dark);
    localStorage.setItem('theme', dark ? 'dark' : 'light');
  };
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerViewLink = document.getElementById('customerViewLink');
    const adminViewLink = document.getElementById('adminViewLink');
    const adminContentContainer = document.getElementById('adminContentContainer');
    const adminMainContent = document.querySelector('.admin-dashboard-main-content');
    if (customerViewLink && adminContentContainer) {
        customerViewLink.addEventListener('click', function(event) {
            event.preventDefault();
            fetch('/admin/customer-books-partial')
                .then(res => res.text())
                .then(html => {
                    adminContentContainer.innerHTML = html;
                    adminContentContainer.style.display = 'block';
                    if (adminMainContent) adminMainContent.style.display = 'none';
                })
                .catch(() => {
                    adminContentContainer.innerHTML = '<div class="alert alert-danger">Failed to load customer view.</div>';
                    adminContentContainer.style.display = 'block';
                    if (adminMainContent) adminMainContent.style.display = 'none';
                });
        });
    }
    if (adminViewLink && adminContentContainer) {
        adminViewLink.addEventListener('click', function(event) {
            event.preventDefault();
            adminContentContainer.innerHTML = '';
            adminContentContainer.style.display = 'none';
            if (adminMainContent) adminMainContent.style.display = 'block';
        });
    }
});
</script>
